version: '3.4'

services:

  mysql-data-test:
    environment:
      MYSQL_USER: ${MYSQL_TEST_USER}
      MYSQL_PASSWORD: ${MYSQL_TEST_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_TEST_ROOT_PASSWORD}
      MYSQL_BUDGETING_DATABASE: ${MYSQL_TEST_BUDGETING_DATABASE}
      MYSQL_OBJECT_STORE_DATABASE: ${MYSQL_TEST_OBJECT_STORE_DATABASE}
    ports:
      - 3306
    volumes:
      - ./mysql-init-scripts:/docker-entrypoint-initdb.d

  budgeting-api-functional-test:
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      HolefeederDatabaseSettings__ConnectionString: Server=mysql-data-test;Port=3306;User Id=${MYSQL_TEST_USER};Password=${MYSQL_TEST_PASSWORD};AllowPublicKeyRetrieval=True;SslMode=none;Database=${MYSQL_TEST_BUDGETING_DATABASE};
    ports:
      - "5105:80"
    entrypoint:
        - dotnet
        - test
        - --logger
        - trx;LogFileName=/tests/budgeting-funtional-test-results.xml
        - --logger
        - html;LogFileName=/tests/budgeting-funtional-test-results.html
        - --logger
        - junit;LogFileName=/tests/budgeting-funtional-test-results.junit.xml
        - --results-directory
        - /tests
        - --collect
        - "XPlat Code Coverage"

  budgeting-api-unit-test:
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
    ports:
      - "5112:80"
    entrypoint:
        - dotnet
        - test
        - --logger
        - trx;LogFileName=/tests/budgeting-unit-test-results.xml
        - --logger
        - html;LogFileName=/tests/budgeting-unit-test-results.html
        - --logger
        - junit;LogFileName=/tests/budgeting-unit-test-results.junit.xml
        - --results-directory
        - /tests
        - --collect
        - "XPlat Code Coverage"

  object-store-api-functional-test:
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
      ObjectStoreDatabaseSettings__ConnectionString: Server=mysql-data-test;Port=3306;User Id=${MYSQL_TEST_USER};Password=${MYSQL_TEST_PASSWORD};AllowPublicKeyRetrieval=True;SslMode=none;Database=${MYSQL_TEST_OBJECT_STORE_DATABASE};
    ports:
      - "5106:80"
    entrypoint:
      - dotnet
      - test
      - --logger
      - trx;LogFileName=/tests/object-store-funtional-test-results.xml
      - --logger
      - html;LogFileName=/tests/object-store-funtional-test-results.html
      - --logger
      - junit;LogFileName=/tests/object-store-funtional-test-results.junit.xml
      - --results-directory
      - /tests
      - --collect
      - "XPlat Code Coverage"

  object-store-api-unit-test:
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:80
    ports:
      - "5113:80"
    entrypoint:
      - dotnet
      - test
      - --logger
      - trx;LogFileName=/tests/object-store-unit-test-results.xml
      - --logger
      - html;LogFileName=/tests/object-store-unit-test-results.html
      - --logger
      - junit;LogFileName=/tests/object-store-unit-test-results.junit.xml
      - --results-directory
      - /tests
      - --collect
      - "XPlat Code Coverage"
